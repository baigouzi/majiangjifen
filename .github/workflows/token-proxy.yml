name: Generate Secure Data Proxy
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Proxy Script
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          REPO_FULL_NAME: ${{ github.repository }}
        run: |
          mkdir -p docs/api
          cat > docs/api/proxy.js << 'EOF'
          const http = require('http');
          const fetch = require('node-fetch');
          
          const PORT = process.env.PORT || 3000;
          const [OWNER, REPO] = process.env.REPO_FULL_NAME.split('/');
          const TOKEN = process.env.GH_TOKEN;
          const DATA_PATH = 'data.json';
          
          const server = http.createServer(async (req, res) => {
            // ========== 此处修改为你的 GitHub Pages 域名 ==========
            res.setHeader('Access-Control-Allow-Origin', 'https://baigouzi.github.io/majiangjifen');
            res.setHeader('Access-Control-Allow-Methods', 'GET, POST');
            res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
            res.setHeader('Content-Type', 'application/json');
          
            if (req.method === 'OPTIONS') {
              res.writeHead(200);
              res.end();
              return;
            }
          
            if (req.url !== '/api/data') {
              res.writeHead(403);
              res.end(JSON.stringify({ error: '禁止访问：仅允许 /api/data 接口' }));
              return;
            }
          
            try {
              const githubApiUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${DATA_PATH}`;
              const headers = {
                'Authorization': `token ${TOKEN}`,
                'Accept': 'application/vnd.github.v3+json'
              };
          
              if (req.method === 'GET') {
                const response = await fetch(githubApiUrl, { headers });
                const data = await response.json();
                const decodedContent = Buffer.from(data.content, 'base64').toString('utf8');
                res.end(JSON.stringify({
                  content: JSON.parse(decodedContent),
                  sha: data.sha
                }));
              } else if (req.method === 'POST') {
                let requestBody = '';
                req.on('data', chunk => requestBody += chunk);
                req.on('end', async () => {
                  try {
                    const { newContent, sha } = JSON.parse(requestBody);
                    if (!newContent || !sha) {
                      res.writeHead(400);
                      res.end(JSON.stringify({ error: '参数缺失：需要 newContent 和 sha' }));
                      return;
                    }
                    const encodedContent = Buffer.from(JSON.stringify(newContent, null, 2)).toString('base64');
                    const response = await fetch(githubApiUrl, {
                      method: 'PUT',
                      headers,
                      body: JSON.stringify({
                        message: 'Update sync data (secure proxy)',
                        content: encodedContent,
                        sha: sha
                      })
                    });
                    res.end(JSON.stringify({ success: response.ok }));
                  } catch (err) {
                    res.writeHead(500);
                    res.end(JSON.stringify({ error: `解析请求体失败：${err.message}` }));
                  }
                });
              }
            } catch (err) {
              res.writeHead(500);
              res.end(JSON.stringify({ error: `服务器错误：${err.message}` }));
            }
          });
          
          server.listen(PORT, () => {
            console.log(`Proxy server running on port ${PORT}`);
          });
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          publish_dir: ./docs
          force_orphan: true
