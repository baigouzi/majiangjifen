<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»å°†è®°åˆ†å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ€„</text></svg>" type="image/svg+xml">
    
    <!-- è‡ªå®šä¹‰Tailwindé…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        mahjong: {
                            red: '#E63946',
                            green: '#457B9D',
                            yellow: '#F1FAEE',
                            dark: '#1D3557',
                            light: '#A8DADC',
                            neonRed: '#FF2D55',
                            neonGreen: '#34D399',
                            neonBlue: '#38BDF8'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon-red': '0 0 5px #FF2D55, 0 0 10px #FF2D55',
                        'neon-green': '0 0 5px #34D399, 0 0 10px #34D399',
                        'neon-blue': '0 0 5px #38BDF8, 0 0 10px #38BDF8',
                        'card': '0 8px 30px rgba(0, 0, 0, 0.12)',
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
			/* æ–°å¢ï¼šéšè—æ»šåŠ¨æ¡ */
			.scrollbar-hide {
				-ms-overflow-style: none;  /* IE and Edge */
				scrollbar-width: none;  /* Firefox */
			}
			.scrollbar-hide::-webkit-scrollbar {
				display: none;  /* Chrome, Safari, Opera */
			}
            .card-shadow {
                box-shadow: var(--tw-shadow-card);
            }
            .score-change {
                position: relative;
                overflow: hidden;	
            }
            .winner-selected {
                border: 2px solid #34D399;
                background-color: rgba(52, 211, 153, 0.1);
                box-shadow: var(--tw-shadow-neon-green);
            }
            .banker-selected {
                border: 2px solid #FF2D55;
                background-color: rgba(255, 45, 85, 0.1);
                box-shadow: var(--tw-shadow-neon-red);
            }
            .banker-candidate {
                border: 2px dashed #FF2D55;
                background-color: rgba(255, 45, 85, 0.05);
            }
            .winner-candidate {
                border: 2px dashed #34D399;
                background-color: rgba(52, 211, 153, 0.05);
            }
            .edit-input {
                @apply w-[100px] px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-mahjong-neonBlue/50 text-sm font-medium;
            }
            .total-edit-input {
                @apply w-[50px] px-2 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-mahjong-neonBlue/50 text-sm font-bold text-right;
            }
            .init-score-input {
                @apply w-full px-2 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-mahjong-neonBlue/50 text-sm;
            }
            /* éšè—æ•°å­—è¾“å…¥æ¡†é»˜è®¤çš„ä¸Šä¸‹ç®­å¤´ */
            input[type="number"]::-webkit-inner-spin-button,
            input[type="number"]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
            input[type="number"] {
                -moz-appearance: textfield;
                appearance: textfield;
            }
            .toast {
                @apply fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-mahjong-dark text-white px-4 py-2 rounded-lg text-sm z-50 opacity-95 transition-all duration-300;
            }
            .base-score-container {
                @apply relative;
            }
            .base-score-btn {
                @apply absolute w-6 h-6 flex items-center justify-center text-xs text-gray-600 bg-mahjong-light rounded-full transition-all hover:scale-110;
            }
            .player-nickname-display {
                @apply text-xs font-medium text-mahjong-dark mb-1 block;
            }
            .disabled-btn {
                @apply opacity-50 cursor-not-allowed;
            }
            .gradient-bg {
                background: linear-gradient(135deg, #F1FAEE 0%, #A8DADC 100%);
            }
            .card-gradient {
                background: linear-gradient(180deg, white 0%, #f9fafb 100%);
            }
            .history-table {
                @apply w-full text-sm border-collapse;
            }
            .history-table th {
                @apply py-2 px-1 text-left text-gray-500 font-medium border-b border-gray-100 sticky top-0 bg-white z-10;
            }
            .history-table td {
                @apply py-2 px-1 border-b border-gray-100;
            }
            .history-row-highlight {
                @apply bg-mahjong-light/20;
            }
            /* çŸ©é˜µå¼è®°åˆ†ç‰Œæ ·å¼ - ä¼˜åŒ–ç‰ˆ */
            .matrix-scoreboard {
                @apply w-full border-collapse text-xs;
            }
            .matrix-scoreboard th {
                @apply py-1 px-1 text-center bg-mahjong-dark/5 font-medium text-gray-600 border border-gray-100;
                white-space: nowrap; /* é˜²æ­¢è¡¨å¤´æ¢è¡Œ */
                font-size: 0.75rem; /* è¿›ä¸€æ­¥ç¼©å°è¡¨å¤´å­—ä½“ */
            }
            .matrix-scoreboard td {
                @apply py-1 px-0.5 text-center border border-gray-100;
                font-size: 0.7rem; /* ç¼©å°å•å…ƒæ ¼å­—ä½“ */
            }
            .matrix-scoreboard .round-col {
                @apply bg-mahjong-light/10 font-medium w-[50px]; /* ç¼©å°å±€æ•°åˆ—å®½åº¦ */
            }
            .matrix-scoreboard .total-row {
                @apply bg-mahjong-dark/10 font-bold;
            }
            .score-positive {
                @apply text-green-600 font-medium;
            }
            .score-negative {
                @apply text-red-600 font-medium;
            }
            .score-zero {
                @apply text-gray-400;
            }
            .init-adjust-row {
                @apply bg-blue-50/50;
            }
            .init-adjust-cell {
                @apply text-blue-600 font-medium;
            }
            /* å¤‡æ³¨åˆ—æ ·å¼ä¼˜åŒ– */
            .note-col {
                @apply w-[70px] max-w-[70px] px-1; /* ç¼©å°å¤‡æ³¨åˆ—å®½åº¦ */
                word-break: break-all; /* å¼ºåˆ¶æ¢è¡Œ */
                white-space: normal; /* å…è®¸æ¢è¡Œ */
                line-height: 1.2; /* ç¼©å°è¡Œé«˜ */
            }
            .note-text {
                @apply text-xs text-gray-500 leading-tight; /* æ›´å°çš„å­—ä½“å’Œç´§å‡‘è¡Œé«˜ */
                display: block; /* å¼ºåˆ¶åˆ†è¡Œæ˜¾ç¤º */
            }
            /* ç»Ÿä¸€ç©å®¶å¡ç‰‡æŒ‰é’®å’Œå¾½ç« æ ·å¼ */
            /* åŸºç¡€å¾½ç« å’ŒæŒ‰é’®æ ·å¼ */
            .banker-badge:not(.hidden),
            .winner-badge:not(.hidden),
            .action-btn:not(.hidden) {
                @apply text-xs font-medium px-2 py-0.5 rounded-full transition-all duration-200;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 40px;
                height: 20px;
                line-height: 20px;
                box-sizing: border-box;
            }
            
            /* åº„å®¶ç›¸å…³ - çº¢è‰²ç³» */
            .banker-badge {
                @apply bg-mahjong-neonRed text-white shadow-neon-red;
            }
            
            /* å½“åº„å®¶å¾½ç« å•ç‹¬æ˜¾ç¤ºæ—¶ï¼Œå‘å³ç§»åŠ¨ */
            .badge-area .banker-badge:not(.hidden) + .winner-badge.hidden {
                margin-left: 0.5rem; /* å‘å³ç§»åŠ¨2ä¸ªå•ä½ï¼ˆ1remçº¦ç­‰äº2ä¸ªTailwindå•ä½ï¼‰ */
            }
            
            .banker-btn {
                @apply bg-mahjong-red text-white shadow-md hover:bg-mahjong-neonRed;
            }
            
            /* èƒ¡ç‰Œç›¸å…³ - ç»¿è‰²ç³» */
            .winner-badge {
                @apply bg-mahjong-neonGreen text-white shadow-neon-green;
                margin-left: -0.5rem; /* å‘å·¦ç§»åŠ¨0.5rem */
            }
            
            .winner-btn {
                @apply bg-mahjong-green text-white shadow-md hover:bg-mahjong-neonGreen;
            }
            
            /* æ“ä½œå®¹å™¨æ ·å¼ */
            .action-container {
                @apply flex items-center gap-2;
            }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-lg">
        <!-- æç¤ºæ¶ˆæ¯ç»„ä»¶ -->
        <div id="toast" class="toast hidden">æ“ä½œæˆåŠŸ</div>
        
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <header class="text-center mb-8 relative">
            <div class="absolute inset-0 bg-mahjong-dark/5 blur-md rounded-xl -z-10"></div>
            <h1 class="text-[clamp(1.8rem,4vw,2.8rem)] font-bold text-mahjong-dark mb-3 relative">
                <i class="fa fa-trophy text-mahjong-neonRed mr-2"></i>éº»å°†è®°åˆ†å™¨
                <span class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-2/3 h-1 bg-gradient-to-r from-mahjong-neonRed to-mahjong-neonGreen rounded-full"></span>
            </h1>
            <p class="text-gray-600 text-sm bg-white/70 px-4 py-2 rounded-full inline-block backdrop-blur-sm">
                åº„é—²å€ç‡ç”Ÿæ•ˆ | é—²é—²èƒ¡ç‰Œå€ç‡1
            </p>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="card-gradient rounded-2xl p-6 card-shadow border border-gray-100">            
            <!-- æœ¬å±€ç»“æœåŒºåŸŸ -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-mahjong-dark border-b border-gray-100 pb-3 text-left flex justify-between items-center w-full">
                        <div>
                            <i class="fa fa-bar-chart text-mahjong-neonGreen mr-2 text-sm"></i>
                            å®æ—¶åˆ†æ•°
                        </div>
                                        
                    <!-- åŸºç¡€åˆ†æ•° -->
                    <div class="w-[120px]">
                        <div class="base-score-container">
                            <div class="absolute top-[-20px] left-0 right-0 text-center text-xs text-gray-500">æœ¬å±€å€ç‡</div>
                            <input type="number" id="base-score" value="1" min="1" 
                                   class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-mahjong-neonBlue/50 focus:border-transparent text-sm pl-8 pr-8 bg-white text-center">
                            <!-- å¢å‡æŒ‰é’®ä¿ç•™ -->
                            <button id="base-score-decrease" class="base-score-btn top-1/2 -translate-y-1/2 left-2 bg-white shadow-sm">
                                <i class="fa fa-minus"></i>
                            </button>
                            <button id="base-score-increase" class="base-score-btn top-1/2 -translate-y-1/2 right-2 bg-white shadow-sm">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    </h2>
                </div>
                
                <div class="space-y-3 mb-6">
                    <!-- ç©å®¶ä¿¡æ¯å¡ç‰‡ï¼ˆä½¿ç”¨ç»Ÿä¸€ç»“æ„å‡å°‘å†—ä½™ï¼‰ -->
                    <div class="score-change bg-white/80 p-3 rounded-xl flex justify-between items-center cursor-pointer hover:bg-white/90 transition-all duration-200" data-player="player1">
                        <span class="font-medium player-name edit-trigger inline-block w-[90px] text-left overflow-hidden whitespace-nowrap" id="display-name1" data-player="player1">ç©å®¶1</span>
                        <div class="flex items-center gap-2">
                            <div class="badge-area grid grid-cols-2 w-[40px] text-right">
                                <span class="banker-badge hidden text-xs">åº„</span>
                                <span class="winner-badge hidden text-xs">èƒ¡</span>
                            </div>

                            <!-- æ“ä½œæŒ‰é’®å®¹å™¨ -->
                            <div class="action-container hidden">
                                <button class="action-btn banker-btn hidden text-xs px-1">ä¸Šåº„</button>
                                <button class="action-btn winner-btn hidden text-xs px-1">èƒ¡</button>
                            </div>
                            <!-- æœ¬å±€åˆ†æ•° -->
                            <div class="text-right min-w-[60px]">
                                <div class="text-xs text-gray-500">æœ¬å±€</div>
                                <span id="player1-score" class="text-mahjong-dark block text-right text-base font-medium">0</span>
                            </div>
                            <!-- ç´¯è®¡æ€»åˆ† -->
                            <div class="text-right min-w-[60px] border-l border-gray-100 pl-2">
                                <div class="text-xs text-gray-500">æ€»åˆ†</div>
                                <span id="player1-total" class="font-bold text-mahjong-neonGreen block text-right text-base transition-all" data-player="player1">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="score-change bg-white/80 p-3 rounded-xl flex justify-between items-center cursor-pointer hover:bg-white/90 transition-all duration-200" data-player="player2">
                        <span class="font-medium player-name edit-trigger inline-block w-[90px] text-left overflow-hidden whitespace-nowrap" id="display-name2" data-player="player2">ç©å®¶2</span>
                        <div class="flex items-center gap-2">
                            <div class="badge-area grid grid-cols-2 w-[40px] text-right">
                                <span class="banker-badge hidden text-xs">åº„</span>
                                <span class="winner-badge hidden text-xs">èƒ¡</span>
                            </div>
                            <!-- æ“ä½œæŒ‰é’®å®¹å™¨ -->
                            <div class="action-container hidden">
                                <button class="action-btn banker-btn hidden text-xs px-1">ä¸Šåº„</button>
                                <button class="action-btn winner-btn hidden text-xs px-1">èƒ¡</button>
                            </div>
                            <div class="text-right min-w-[60px]">
                                <div class="text-xs text-gray-500">æœ¬å±€</div>
                                <span id="player2-score" class="text-mahjong-dark block text-right text-base font-medium">0</span>
                        </div>
                        <!-- ç´¯è®¡æ€»åˆ† -->
                        <div class="text-right min-w-[60px] border-l border-gray-100 pl-2">
                            <div class="text-xs text-gray-500">æ€»åˆ†</div>
                            <span id="player2-total" class="font-bold text-mahjong-neonGreen block text-right text-base transition-all" data-player="player2">0</span>
                        </div>
                        </div>
                    </div>
                    
                    <div class="score-change bg-white/80 p-3 rounded-xl flex justify-between items-center cursor-pointer hover:bg-white/90 transition-all duration-200" data-player="player3">
                        <span class="font-medium player-name edit-trigger inline-block w-[90px] text-left overflow-hidden whitespace-nowrap" id="display-name3" data-player="player3">ç©å®¶3</span>
                        <div class="flex items-center gap-2">
                            <div class="badge-area grid grid-cols-2 w-[40px] text-right">
                                <span class="banker-badge hidden text-xs">åº„</span>
                                <span class="winner-badge hidden text-xs">èƒ¡</span>
                            </div>
                            <!-- æ“ä½œæŒ‰é’®å®¹å™¨ -->
                            <div class="action-container hidden">
                                <button class="action-btn banker-btn hidden text-xs px-1">ä¸Šåº„</button>
                                <button class="action-btn winner-btn hidden text-xs px-1">èƒ¡</button>
                            </div>
                            <div class="text-right min-w-[60px]">
                                <div class="text-xs text-gray-500">æœ¬å±€</div>
                                <span id="player3-score" class="text-mahjong-dark block text-right text-base font-medium">0</span>
                            </div>
                            <!-- ç´¯è®¡æ€»åˆ† -->
                            <div class="text-right min-w-[60px] border-l border-gray-100 pl-2">
                                <div class="text-xs text-gray-500">æ€»åˆ†</div>
                                <span id="player3-total" class="font-bold text-mahjong-neonGreen block text-right text-base transition-all" data-player="player3">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="score-change bg-white/80 p-3 rounded-xl flex justify-between items-center cursor-pointer hover:bg-white/90 transition-all duration-200" data-player="player4">
                        <span class="font-medium player-name edit-trigger inline-block w-[90px] text-left overflow-hidden whitespace-nowrap" id="display-name4" data-player="player4">ç©å®¶4</span>
                        <div class="flex items-center gap-2">
                            <div class="badge-area grid grid-cols-2 w-[40px] text-right">
                                <span class="banker-badge hidden text-xs">åº„</span>
                                <span class="winner-badge hidden text-xs">èƒ¡</span>
                            </div>
                            <!-- æ“ä½œæŒ‰é’®å®¹å™¨ -->
                            <div class="action-container hidden">
                                <button class="action-btn banker-btn hidden text-xs px-1">ä¸Šåº„</button>
                                <button class="action-btn winner-btn hidden text-xs px-1">èƒ¡</button>
                            </div>
                            <div class="text-right min-w-[60px]">
                                <div class="text-xs text-gray-500">æœ¬å±€</div>
                                <span id="player4-score" class="text-mahjong-dark block text-right text-base font-medium">0</span>
                            </div>
                            <!-- ç´¯è®¡æ€»åˆ† -->
                            <div class="text-right min-w-[60px] border-l border-gray-100 pl-2">
                                <div class="text-xs text-gray-500">æ€»åˆ†</div>
                                <span id="player4-total" class="font-bold text-mahjong-neonGreen block text-right text-base transition-all" data-player="player4">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å†å²è®°å½•æŒ‰é’® -->
                <button id="history-btn" class="w-full bg-gradient-to-r from-mahjong-green to-mahjong-neonGreen text-white py-2 rounded-xl text-sm font-medium shadow-lg shadow-mahjong-green/20 hover:opacity-90 transition-all">
                    <i class="fa fa-history mr-2"></i>è®¡åˆ†æ¿
                </button>
            </div>
            
            <!-- æ¸¸æˆè®¾ç½®åŒºåŸŸï¼ˆç®€åŒ–ç‰ˆï¼‰ -->
            <div class="mb-8">
                <div class="space-y-4">
                    <!-- åˆå¹¶è¡Œï¼šåº„å®¶å€ç‡ + é‡ç½®æ€»åˆ† + é‡ç½®åº„å®¶ -->
                    <div class="grid grid-cols-12 gap-4">
                        <!-- åº„å®¶å€ç‡ä¸‹æ‹‰ -->
                        <div class="col-span-4">
                            <select id="multiplier-select" class="w-full bg-mahjong-light border border-mahjong-light text-white py-2 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-mahjong-neonGreen/50 focus:border-transparent">
                                <option value="1">1å€ (åº„é—²ç”Ÿæ•ˆ)</option>
								<option value="2">2å€ (åº„é—²ç”Ÿæ•ˆ)</option>
                                <option value="4">4å€ (åº„é—²ç”Ÿæ•ˆ)</option>
                                <option value="8" selected>8å€ (åº„é—²ç”Ÿæ•ˆ)</option>
                            </select>
                            <input type="hidden" id="selected-multiplier" value="8">
                        </div>
                        
                        <!-- é‡ç½®æŒ‰é’®ç»„ -->
                        <div class="col-span-4">
                            <button id="reset-total-btn" class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white py-2 rounded-xl text-sm font-medium hover:opacity-90 transition-all">
                                <i class="fa fa-refresh mr-2"></i>é‡ç½®æ€»åˆ†
                            </button>
                        </div>
                        
                        <div class="col-span-4">
                            <button id="reset-banker-btn" class="w-full bg-gradient-to-r from-gray-400 to-gray-500 text-white py-2 rounded-xl text-sm font-medium hover:opacity-90 transition-all">
                                <i class="fa fa-star mr-2"></i>é‡ç½®åº„å®¶
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å•ç‹¬çš„åˆ†æ•°è°ƒæ•´åŒºåŸŸ -->
            <div class="mb-8">
                <div class="p-4 bg-white/50 rounded-xl border border-gray-100">
                    <div class="grid grid-cols-12 gap-4 mb-3">
                        <!-- é€‰æ‹©è°ƒæ•´å¯¹è±¡ -->
                        <div class="col-span-4">
                            <label class="block text-gray-700 font-medium text-sm mb-1.5">è°ƒæ•´å¯¹è±¡</label>
                            <select id="score-adjust-target" class="w-full bg-white border border-gray-200 text-gray-700 py-2 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-mahjong-neonBlue/50 focus:border-transparent">
                                <option value="all">å…¨ä½“ç©å®¶</option>
                                <option value="player1">ç©å®¶1</option>
                                <option value="player2">ç©å®¶2</option>
                                <option value="player3">ç©å®¶3</option>
                                <option value="player4">ç©å®¶4</option>
                            </select>
                        </div>
                        
                        <!-- è¾“å…¥è°ƒæ•´åˆ†æ•° -->
                        <div class="col-span-5">
                            <label class="block text-gray-700 font-medium text-sm mb-1.5">è°ƒæ•´åˆ†æ•°</label>
                            <input type="number" id="score-adjust-value" value="0" 
                                   class="init-score-input" placeholder="è¾“å…¥è°ƒæ•´åˆ†æ•°">
                        </div>
                        
                        <!-- è°ƒæ•´æŒ‰é’® -->
                        <div class="col-span-3 flex items-end">
                            <button id="apply-adjust-btn" class="w-full bg-gradient-to-r from-mahjong-dark to-gray-700 text-white py-2 rounded-xl text-sm font-medium hover:opacity-90 transition-all">
                                <i class="fa fa-check"></i>
                            </button>
                        </div>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-2 italic">
                        æ³¨ï¼šæ­£æ•°ä¸ºåŠ åˆ†ï¼Œè´Ÿæ•°ä¸ºå‡åˆ†ï¼Œæ­¤æ“ä½œä¼šè®°å½•åˆ°å†å²è®°å½•ä¸­
                    </p>
                </div>
            </div>


        </main>
        
        <!-- å†å²è®°å½•æ¨¡æ€æ¡† - çŸ©é˜µå¼è®°åˆ†ç‰Œ -->
        <div id="history-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden backdrop-blur-sm">
            <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 max-h-[80vh] overflow-y-auto shadow-2xl scrollbar-hide" id="modal-content">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100">
                    <h3 class="text-lg font-semibold text-mahjong-dark flex items-center">
                        <i class="fa fa-history text-mahjong-neonBlue mr-2"></i>è®¡åˆ†æ¿
                    </h3>
                    <button id="close-modal" class="text-gray-500 p-1 rounded-full">
                        <i class="fa fa-times text-lg"></i>
                    </button>
                </div>
                
                <!-- çŸ©é˜µå¼è®°åˆ†ç‰Œ -->
                <div id="history-list" class="mb-4">
                    <div id="history-records-container">
                        <p class="text-gray-500 text-center italic py-8">æš‚æ— è®°å½•</p>
                    </div>
                </div>
                
                <div class="flex gap-2 mt-2">
                    <button id="clear-history" class="flex-1 text-mahjong-neonRed border border-mahjong-neonRed/20 rounded-xl py-2 text-sm font-medium hover:bg-mahjong-neonRed/5 transition-all">
                        æ¸…ç©ºè®°å½•
                    </button>
                </div>
            </div>
        </div>
        
        <!-- é¡µè„š -->
        <footer class="mt-8 text-center text-gray-500 text-xs bg-white/70 p-4 rounded-xl backdrop-blur-sm">
            <p class="flex flex-wrap justify-center gap-2">
                <span>éº»å°†è®°åˆ†å™¨ Â© 2025</span>
                <span>|</span>
                <span>ç‚¹å‡»ç©å®¶é€‰æ‹©åº„å®¶/èƒ¡ç‰Œ</span>
                <span>|</span>
                <span>åº„é—²å€ç‡è§„åˆ™</span>
                <span>|</span>
                <span>é—²é—²èƒ¡ç‰Œ1å€</span>
                <span>|</span>
                <span>åŸºç¡€åˆ†ä»…æ”¯æŒ2çš„æ¬¡å¹‚å€¼</span>
                <span>|</span>
                <span>æ€»åˆ†æ”¯æŒæ‰‹åŠ¨ç¼–è¾‘</span>
                <span>|</span>
                <span>åˆå§‹åˆ†æ”¯æŒç´¯åŠ æ¨¡å¼</span>
            </p>
        </footer>
    </div>

    <script>
        // åˆå§‹åŒ–å˜é‡
        let historyRecords = [];
        let selectedMultiplier = 8; // é»˜è®¤å€ç‡æ”¹ä¸º8å€
        let currentBanker = ''; // å½“å‰åº„å®¶
        let playerNicknames = {
            player1: "ç©å®¶1",
            player2: "ç©å®¶2",
            player3: "ç©å®¶3",
            player4: "ç©å®¶4"
        };
        let playerTotalScores = {
            player1: 0,
            player2: 0,
            player3: 0,
            player4: 0
        };
        let currentRoundScores = {
            player1: 0,
            player2: 0,
            player3: 0,
            player4: 0
        };
        let selectedWinner = null; // èƒ¡ç‰Œç©å®¶
        let isEditing = false; // é˜²æ­¢åŒæ—¶ç¼–è¾‘å¤šä¸ªæ˜µç§°/æ€»åˆ†
        let activePlayerCard = null; // å½“å‰æ¿€æ´»çš„ç©å®¶å¡ç‰‡
        // 2çš„æ¬¡å¹‚åŸºç¡€åˆ†å€¼åˆ—è¡¨
        const powerOfTwoValues = [1, 2, 4, 8, 16, 32, 64, 128, 256, 512];
        // è®°å½•å½“å‰å±€æ•°ï¼ˆåŒ…å«åˆå§‹åˆ†è°ƒæ•´è®°å½•ï¼‰
        let currentRoundNumber = 0;
        
        // DOMå…ƒç´ 
        const baseScoreInput = document.getElementById('base-score');
        const baseScoreDecrease = document.getElementById('base-score-decrease');
        const baseScoreIncrease = document.getElementById('base-score-increase');
        const multiplierSelect = document.getElementById('multiplier-select');
        const selectedMultiplierInput = document.getElementById('selected-multiplier');
        const resetTotalBtn = document.getElementById('reset-total-btn');
        const resetBankerBtn = document.getElementById('reset-banker-btn');
        const toast = document.getElementById('toast');
        
        // åˆ†æ•°è°ƒæ•´ç›¸å…³å…ƒç´ 
        const scoreAdjustTarget = document.getElementById('score-adjust-target');
        const scoreAdjustValue = document.getElementById('score-adjust-value');
        const applyAdjustBtn = document.getElementById('apply-adjust-btn');
        
        // åˆ†æ•°å…ƒç´ 
        const playerScores = {
            player1: document.getElementById('player1-score'),
            player2: document.getElementById('player2-score'),
            player3: document.getElementById('player3-score'),
            player4: document.getElementById('player4-score')
        };
        const playerTotals = {
            player1: document.getElementById('player1-total'),
            player2: document.getElementById('player2-total'),
            player3: document.getElementById('player3-total'),
            player4: document.getElementById('player4-total')
        };
        
        // æ˜µç§°å…ƒç´ 
        const displayNames = {
            player1: document.getElementById('display-name1'),
            player2: document.getElementById('display-name2'),
            player3: document.getElementById('display-name3'),
            player4: document.getElementById('display-name4')
        };
        const editTriggers = document.querySelectorAll('.edit-trigger');
        
        // ç»“æœåŒºå…ƒç´ 
        const playerCards = document.querySelectorAll('.score-change[data-player]');
        const winnerBadges = document.querySelectorAll('.winner-badge');
        const bankerBadges = document.querySelectorAll('.banker-badge');
        
        // å†å²è®°å½•å…ƒç´ 
        const historyBtn = document.getElementById('history-btn');
        const historyModal = document.getElementById('history-modal');
        const modalContent = document.getElementById('modal-content');
        
        // éªŒè¯DOMå…ƒç´ åˆå§‹åŒ–
        console.log('DOM Elements initialized:');
        console.log('  - Base Score Elements:', { baseScoreInput: !!baseScoreInput, baseScoreDecrease: !!baseScoreDecrease, baseScoreIncrease: !!baseScoreIncrease });
        console.log('  - Multiplier Elements:', { multiplierSelect: !!multiplierSelect, selectedMultiplierInput: !!selectedMultiplierInput });
        console.log('  - Button Elements:', { resetTotalBtn: !!resetTotalBtn, resetBankerBtn: !!resetBankerBtn });
        console.log('  - Toast Element:', !!toast);
        console.log('  - Score Adjust Elements:', { scoreAdjustTarget: !!scoreAdjustTarget, scoreAdjustValue: !!scoreAdjustValue, applyAdjustBtn: !!applyAdjustBtn });
        console.log('  - Player Scores:', Object.fromEntries(Object.entries(playerScores).map(([key, value]) => [key, !!value])));
        console.log('  - Player Totals:', Object.fromEntries(Object.entries(playerTotals).map(([key, value]) => [key, !!value])));
        console.log('  - Display Names:', Object.fromEntries(Object.entries(displayNames).map(([key, value]) => [key, !!value])));
        
        // éªŒè¯å…³é”®DOMå…ƒç´ æ˜¯å¦å¯ç”¨
        const criticalElements = { playerScores, playerTotals, displayNames };
        const allCriticalElementsExist = Object.values(criticalElements).every(elementSet => 
            Object.values(elementSet).every(element => element !== null && element !== undefined)
        );
        console.log('  - All Critical Elements Exist:', allCriticalElementsExist);
        
        const closeModal = document.getElementById('close-modal');
        const historyList = document.getElementById('history-list');
        const historyRecordsContainer = document.getElementById('history-records-container');
        const clearHistoryBtn = document.getElementById('clear-history');
        
        console.log('  - History Elements:', { closeModal: !!closeModal, historyList: !!historyList, historyRecordsContainer: !!historyRecordsContainer, clearHistoryBtn: !!clearHistoryBtn });
        console.log('  - Other Elements:', { editTriggers: editTriggers.length, playerCards: playerCards.length, winnerBadges: winnerBadges.length, bankerBadges: bankerBadges.length, historyBtn: !!historyBtn, historyModal: !!historyModal, modalContent: !!modalContent });
        
        // åˆå§‹åŒ–æ•°æ®æµå‘è¿½è¸ª
        console.log('=== Data Flow Tracking Initialized ===');
        console.log('Initial playerTotalScores:', playerTotalScores);
        console.log('Initial currentRoundScores:', currentRoundScores);
        console.log('Initial historyRecords:', historyRecords);
        console.log('Initial currentBanker:', currentBanker);
        console.log('Initial selectedMultiplier:', selectedMultiplier);
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, duration = 2000) {
            toast.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, duration);
        }
        
        function hideAllActionButtons() {
    playerCards.forEach(card => {
        const actionContainer = card.querySelector('.action-container');
        if (actionContainer) {
            actionContainer.classList.add('hidden');
            // éšè—å…·ä½“æŒ‰é’®
            const bankerBtn = actionContainer.querySelector('.banker-btn');
            const winnerBtn = actionContainer.querySelector('.winner-btn');
            if (bankerBtn) bankerBtn.classList.add('hidden');
            if (winnerBtn) winnerBtn.classList.add('hidden');
        }
        // ç§»é™¤å€™é€‰æ ·å¼
        card.classList.remove('banker-candidate', 'winner-candidate');
    });
    activePlayerCard = null;
}
        
        // æ›´æ–°ç©å®¶å¡ç‰‡çŠ¶æ€
        function updatePlayerCardState() {
            playerCards.forEach(card => {
                const player = card.getAttribute('data-player');
                const bankerBadge = card.querySelector('.banker-badge');
                const winnerBadge = card.querySelector('.winner-badge');
                
                // æ›´æ–°åº„å®¶å¾½ç« 
                if (currentBanker === player) {
                    bankerBadge.classList.remove('hidden');
                    card.classList.add('banker-selected');
                } else {
                    bankerBadge.classList.add('hidden');
                    card.classList.remove('banker-selected');
                }
                
                // æ›´æ–°èƒ¡ç‰Œå¾½ç« 
                if (selectedWinner === player) {
                    winnerBadge.classList.remove('hidden');
                    card.classList.add('winner-selected');
                } else {
                    winnerBadge.classList.add('hidden');
                    card.classList.remove('winner-selected');
                }
            });
        }
        
        // è®¾ç½®åŸºç¡€åˆ†å€¼ï¼ˆè‡ªåŠ¨ä¿®æ­£ä¸ºåˆæ³•å€¼ï¼‰
        function setBaseScore(value) {
            let validValue = value;
            if (!powerOfTwoValues.includes(validValue)) {
                validValue = powerOfTwoValues.reduce((prev, curr) => {
                    return curr <= validValue ? curr : prev;
                }, 1);
                showToast(`åŸºç¡€åˆ†è‡ªåŠ¨ä¿®æ­£ä¸º${validValue}ï¼ˆä»…æ”¯æŒ2çš„æ¬¡å¹‚å€¼ï¼‰`);
            }
            baseScoreInput.value = validValue;
        }
        
        // æ›´æ–°æ‰€æœ‰ç©å®¶åç§°æ˜¾ç¤º
        function updateAllPlayerNames() {
            // æ›´æ–°ç»“æœåŒºåŸŸæ˜¾ç¤ºåç§°
            Object.keys(displayNames).forEach(player => {
                displayNames[player].textContent = playerNicknames[player];
            });
            
            // æ›´æ–°åˆ†æ•°è°ƒæ•´ä¸‹æ‹‰æ¡†é€‰é¡¹æ–‡å­—
            Object.keys(playerNicknames).forEach(player => {
                const option = scoreAdjustTarget.querySelector(`option[value="${player}"]`);
                if (option) option.textContent = playerNicknames[player];
            });
            
            // æ›´æ–°å†å²è®°å½•
            updateHistoryList();
        }
        
        // åº”ç”¨åˆ†æ•°è°ƒæ•´
        function applyScoreAdjustment() {
            const target = scoreAdjustTarget.value;
            const value = parseInt(scoreAdjustValue.value) || 0;
            
            if (value === 0) {
                showToast('è¯·è¾“å…¥è°ƒæ•´åˆ†æ•°');
                return;
            }
            
            // åˆ›å»ºè°ƒæ•´è®°å½•
            const adjustmentRecord = {
                type: 'adjustment',
                round: currentRoundNumber + 1,
                scores: {},
                banker: currentBanker,
                winner: null,
                timestamp: new Date().toLocaleString(),
                adjustment: { target, value }
            };
            
            // åº”ç”¨è°ƒæ•´
            if (target === 'all') {
                // å…¨ä½“è°ƒæ•´
                Object.keys(playerTotalScores).forEach(player => {
                    playerTotalScores[player] += value;
                    adjustmentRecord.scores[player] = value;
                });
                showToast(`å·²ä¸ºæ‰€æœ‰ç©å®¶${value > 0 ? 'åŠ ' : 'å‡'}${Math.abs(value)}åˆ†`);
            } else {
                // å•ç‹¬è°ƒæ•´
                playerTotalScores[target] += value;
                adjustmentRecord.scores[target] = value;
                
                // å…¶ä»–ç©å®¶åˆ†æ•°ä¸å˜
                Object.keys(playerTotalScores).forEach(player => {
                    if (player !== target) {
                        adjustmentRecord.scores[player] = 0;
                    }
                });
                
                showToast(`å·²ä¸º${playerNicknames[target]}${value > 0 ? 'åŠ ' : 'å‡'}${Math.abs(value)}åˆ†`);
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updateTotalScoresDisplay();
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            historyRecords.push(adjustmentRecord);
            currentRoundNumber++;
            
            // ä¿å­˜æ•°æ®
            saveTotalScoresToLocalStorage();
            localStorage.setItem('mahjongHistory', JSON.stringify(historyRecords));
            // å¼‚æ­¥ä¿å­˜åˆ° KV
            (async () => {
                await saveToKV({ history: historyRecords });
            })();
            
            // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
            updateHistoryList();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            scoreAdjustValue.value = 0;
        }
        
        // è®¡ç®—å¹¶ä¿å­˜å¾—åˆ†
        function calculateAndSaveScores() {
            if (!currentBanker || !selectedWinner) {
                showToast('è¯·å…ˆè®¾ç½®åº„å®¶å’Œèƒ¡ç‰Œè€…');
                return false;
            }
            
            // è·å–åŸºç¡€åˆ†å’Œå€ç‡
            const baseScore = parseInt(baseScoreInput.value) || 1;
            const multiplier = selectedMultiplier;
            
            // è®¡ç®—å¾—åˆ†
            const scores = {};
            
            // è®¡ç®—èƒ¡ç‰Œè€…å¾—åˆ†
            if (currentBanker === selectedWinner) {
                // åº„å®¶èƒ¡ç‰Œï¼šæ¯ä¸ªé—²å®¶è¾“ baseScore * multiplier
                scores[selectedWinner] = baseScore * multiplier * 3;
                Object.keys(playerTotalScores).forEach(player => {
                    if (player !== selectedWinner) {
                        scores[player] = -baseScore * multiplier;
                    }
                });
            } else {
                // é—²å®¶èƒ¡ç‰Œï¼šåº„å®¶è¾“ baseScore * multiplierï¼Œå…¶ä»–é—²å®¶è¾“ baseScore
                scores[selectedWinner] = baseScore * multiplier + baseScore * 2;
                scores[currentBanker] = -baseScore * multiplier;
                
                Object.keys(playerTotalScores).forEach(player => {
                    if (player !== selectedWinner && player !== currentBanker) {
                        scores[player] = -baseScore;
                    }
                });
            }
            
            // æ›´æ–°æœ¬å±€åˆ†æ•°å­˜å‚¨å’Œæ˜¾ç¤º
            currentRoundScores = scores;
            Object.keys(scores).forEach(player => {
                if (playerScores[player]) {
                    playerScores[player].textContent = scores[player];
                    playerScores[player].classList.remove('score-positive', 'score-negative', 'score-zero');
                    if (scores[player] > 0) {
                        playerScores[player].classList.add('score-positive');
                    } else if (scores[player] < 0) {
                        playerScores[player].classList.add('score-negative');
                    } else {
                        playerScores[player].classList.add('score-zero');
                    }
                }
            });
            
            // æ›´æ–°æ€»åˆ†
            Object.keys(scores).forEach(player => {
                playerTotalScores[player] += scores[player];
            });
            updateTotalScoresDisplay();
            
            // è®°å½•æœ¬å±€ç»“æœåˆ°å†å²
            currentRoundNumber++;
            const roundRecord = {
                type: 'round',
                round: currentRoundNumber,
                scores: scores,
                banker: currentBanker,
                winner: selectedWinner,
                baseScore: baseScore,
                multiplier: multiplier,
                timestamp: new Date().toLocaleString()
            };
            historyRecords.push(roundRecord);
            
            // èƒ¡ç‰Œè€…æˆä¸ºæ–°çš„åº„å®¶
            currentBanker = selectedWinner;
            
            // æ¸…é™¤å½“å‰èƒ¡ç‰Œé€‰æ‹©
            selectedWinner = null;
            
            // ä¿å­˜æ•°æ®
            saveTotalScoresToLocalStorage();
            saveBankerToLocalStorage();
            localStorage.setItem('mahjongHistory', JSON.stringify(historyRecords));
            // å¼‚æ­¥ä¿å­˜åˆ° KV
            (async () => {
                await saveToKV({ history: historyRecords });
            })();
            
            // æ›´æ–°æ˜¾ç¤º
            updatePlayerCardState();
            updateHistoryList();
            
            // éšè—æ“ä½œæŒ‰é’®
            hideAllActionButtons();
            

            
            showToast('åˆ†æ•°è®¡ç®—å®Œæˆï¼Œå·²è®°å½•æœ¬å±€ç»“æœ');
            return true;
        }
        






        // EdgeOne Pages KV ç›¸å…³å‡½æ•°
        // æ£€æµ‹æ˜¯å¦åœ¨ Edge ç¯å¢ƒä¸­
        function isEdgeEnvironment() {
            // å°è¯•æ£€æµ‹ Edge Runtime ç¯å¢ƒ
            const edgeRuntimeExists = typeof EdgeRuntime !== 'undefined';
            const edgeRuntimeValue = edgeRuntimeExists ? EdgeRuntime : 'undefined';
            
            const myKvExists = typeof my_kv !== 'undefined';
            const myKvDetails = my_kv ? {
                type: typeof my_kv,
                hasGetMethod: typeof my_kv.get === 'function',
                hasPutMethod: typeof my_kv.put === 'function',
                hasDeleteMethod: typeof my_kv.delete === 'function',
                hasListMethod: typeof my_kv.list === 'function',
                methods: Object.keys(my_kv).filter(key => typeof my_kv[key] === 'function')
            } : 'undefined';
            
            // æ£€æŸ¥å…¶ä»–å¯èƒ½çš„è¾¹ç¼˜ç¯å¢ƒæ ‡è¯†
            const hasEdgeWorker = typeof EdgeWorker !== 'undefined';
            const hasGlobalMyKv = typeof window !== 'undefined' && typeof window.my_kv !== 'undefined';
            const scriptUrls = Array.from(document.querySelectorAll('script')).map(script => script.src);
            const hasEdgeOneScript = scriptUrls.some(url => url.includes('edgeone'));
            
            console.log('isEdgeEnvironment check:', { 
                edgeRuntimeExists, 
                edgeRuntimeValue,
                myKvExists, 
                myKvDetails,
                hasEdgeWorker,
                hasGlobalMyKv,
                hasEdgeOneScript,
                windowLocation: window.location.href,
                userAgent: navigator.userAgent
            });
            
            // å¢å¼ºçš„ç¯å¢ƒæ£€æµ‹é€»è¾‘
            const isEdge = edgeRuntimeExists || myKvExists || hasEdgeWorker;
            console.log('isEdgeEnvironment result:', isEdge);
            
            return isEdge;
        }

        // ä» KV è·å–æ•°æ®
        async function kvGet(key, type = 'json') {
            try {
                console.log('kvGet called for key:', key, 'with type:', type);
                if (!isEdgeEnvironment() || typeof my_kv === 'undefined') {
                    console.log('kvGet: Not in Edge environment or my_kv is undefined');
                    // ä¸åœ¨ Edge ç¯å¢ƒæˆ–æœªç»‘å®š KVï¼Œè¿”å› null
                    return null;
                }
                const value = await my_kv.get(key, { type });
                console.log('kvGet result for key', key, ':', {
                    hasValue: value !== null,
                    valueType: typeof value,
                    valueLength: value ? JSON.stringify(value).length : 0
                });
                return value;
            } catch (error) {
                console.error('KV Get Error for key', key, ':', { 
                    message: error.message, 
                    stack: error.stack, 
                    name: error.name 
                });
                return null;
            }
        }

        // ä¿å­˜æ•°æ®åˆ° KV
        async function kvPut(key, value) {
            try {
                const valueString = JSON.stringify(value);
                console.log('kvPut called for key:', key, 'with value:', {
                    valueType: typeof value,
                    valueLength: valueString.length,
                    preview: valueString.substring(0, 500) + (valueString.length > 500 ? '...' : '')
                });
                if (!isEdgeEnvironment() || typeof my_kv === 'undefined') {
                    console.log('kvPut: Not in Edge environment or my_kv is undefined');
                    // ä¸åœ¨ Edge ç¯å¢ƒæˆ–æœªç»‘å®š KVï¼Œç›´æ¥è¿”å›
                    return false;
                }
                await my_kv.put(key, valueString);
                console.log('kvPut succeeded for key:', key);
                return true;
            } catch (error) {
                console.error('KV Put Error for key', key, ':', { 
                    message: error.message, 
                    stack: error.stack, 
                    name: error.name 
                });
                return false;
            }
        }

        // åˆå¹¶å†å²è®°å½•æ•°ç»„
        function mergeHistoryRecords(localHistory, kvHistory) {
            if (!localHistory || !Array.isArray(localHistory)) {
                return kvHistory || [];
            }
            if (!kvHistory || !Array.isArray(kvHistory)) {
                return localHistory || [];
            }
            
            // ä½¿ç”¨ Set å»é‡ï¼Œä»¥ round å’Œ timestamp ä½œä¸ºå”¯ä¸€æ ‡è¯†
            const mergedSet = new Map();
            
            // å…ˆæ·»åŠ æœ¬åœ°å†å²è®°å½•
            localHistory.forEach(record => {
                if (record && record.round) {
                    const key = `${record.round}-${record.timestamp || record.type}`;
                    mergedSet.set(key, record);
                }
            });
            
            // å†æ·»åŠ  KV å†å²è®°å½•ï¼ˆè¦†ç›–ç›¸åŒé”®çš„è®°å½•ï¼‰
            kvHistory.forEach(record => {
                if (record && record.round) {
                    const key = `${record.round}-${record.timestamp || record.type}`;
                    mergedSet.set(key, record);
                }
            });
            
            // è½¬æ¢å›æ•°ç»„å¹¶æŒ‰ round å­—æ®µæ’åº
            return Array.from(mergedSet.values()).sort((a, b) => {
                return (a.round || 0) - (b.round || 0);
            });
        }

        // æ•°æ®å†²çªå¤„ç†ï¼šæ¯”è¾ƒæ—¶é—´æˆ³ï¼Œè¿”å›æ›´æ–°çš„æ•°æ®
        function resolveDataConflict(localData, kvData, key) {
            console.log('resolveDataConflict called for key:', key);
            console.log('resolveDataConflict - localData:', localData);
            console.log('resolveDataConflict - kvData:', kvData);
            
            if (!localData || !kvData) {
                console.log('resolveDataConflict - one of the data is null/undefined');
                const result = kvData || localData;
                console.log('resolveDataConflict - result:', result);
                return result;
            }
            
            // ç‰¹æ®Šå¤„ç†å†å²è®°å½•åˆå¹¶
            if (key === 'history' && Array.isArray(localData) && Array.isArray(kvData)) {
                console.log('resolveDataConflict - merging history records');
                const merged = mergeHistoryRecords(localData, kvData);
                console.log('resolveDataConflict - merged history length:', merged.length);
                return merged;
            }
            
            // å¦‚æœæ•°æ®æ˜¯å¯¹è±¡ç±»å‹ï¼Œæ£€æŸ¥æ—¶é—´æˆ³
            if (typeof localData === 'object' && typeof kvData === 'object') {
                const localTimestamp = localData._timestamp || 0;
                const kvTimestamp = kvData._timestamp || 0;
                
                console.log('resolveDataConflict - timestamp comparison:', { localTimestamp, kvTimestamp });
                
                // è¿”å›æ—¶é—´æˆ³è¾ƒæ–°çš„æ•°æ®
                if (kvTimestamp > localTimestamp) {
                    console.log('resolveDataConflict - using KV data (newer timestamp)');
                    return kvData;
                } else {
                    console.log('resolveDataConflict - using local data (newer or equal timestamp)');
                    return localData;
                }
            }
            
            // å¯¹äºç®€å•æ•°æ®ç±»å‹ï¼Œè¿”å› KV æ•°æ®
            console.log('resolveDataConflict - using KV data (simple data type)');
            return kvData;
        }

        // ä¸ºæ•°æ®æ·»åŠ æ—¶é—´æˆ³
        function addTimestamp(data) {
            if (typeof data === 'object' && data !== null && !Array.isArray(data)) {
                return { ...data, _timestamp: Date.now() };
            }
            return data;
        }

        // ä» KV åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadFromKV() {
            console.log('loadFromKV called');
            
            // é€ä¸ªåŠ è½½æ¯ä¸ªé”®å¹¶è®°å½•ç»“æœ
            const nicknames = await kvGet('mahjongNicknames');
            const totalScores = await kvGet('mahjongTotalScores');
            const currentRoundScores = await kvGet('mahjongCurrentRoundScores');
            const history = await kvGet('mahjongHistory');
            const banker = await kvGet('mahjongCurrentBanker');
            const multiplier = await kvGet('mahjongMultiplier');
            
            const data = {
                nicknames,
                totalScores,
                currentRoundScores,
                history,
                banker,
                multiplier
            };
            
            // è¯¦ç»†è®°å½•æ¯ä¸ªé”®çš„åŠ è½½çŠ¶æ€
            console.log('loadFromKV completed with data:');
            console.log('  - mahjongNicknames:', nicknames ? `Loaded (${JSON.stringify(nicknames).length} chars)` : 'Not found');
            console.log('  - mahjongTotalScores:', totalScores ? `Loaded (${JSON.stringify(totalScores).length} chars)` : 'Not found');
            console.log('  - mahjongCurrentRoundScores:', currentRoundScores ? `Loaded (${JSON.stringify(currentRoundScores).length} chars)` : 'Not found');
            console.log('  - mahjongHistory:', history ? `Loaded (${history.length} records)` : 'Not found');
            console.log('  - mahjongCurrentBanker:', banker ? banker : 'Not found');
            console.log('  - mahjongMultiplier:', multiplier ? multiplier : 'Not found');
            
            return data;
        }

        // ä¿å­˜æ‰€æœ‰æ•°æ®åˆ° KV
        async function saveToKV(data) {
            console.log('saveToKV called with data keys:', Object.keys(data));
            const promises = [];
            const operations = [];
            
            // è®°å½•æ¯ä¸ªè¦ä¿å­˜çš„æ•°æ®çš„è¯¦ç»†ä¿¡æ¯
            if (data.nicknames) {
                console.log('saveToKV: Preparing to save mahjongNicknames:', { length: JSON.stringify(data.nicknames).length });
                operations.push({ key: 'mahjongNicknames', data: data.nicknames });
                promises.push(kvPut('mahjongNicknames', data.nicknames));
            }
            if (data.totalScores) {
                console.log('saveToKV: Preparing to save mahjongTotalScores:', { length: JSON.stringify(data.totalScores).length, hasTimestamp: !!data.totalScores._timestamp });
                operations.push({ key: 'mahjongTotalScores', data: data.totalScores });
                promises.push(kvPut('mahjongTotalScores', data.totalScores));
            }
            if (data.currentRoundScores) {
                console.log('saveToKV: Preparing to save mahjongCurrentRoundScores:', { length: JSON.stringify(data.currentRoundScores).length, hasTimestamp: !!data.currentRoundScores._timestamp });
                operations.push({ key: 'mahjongCurrentRoundScores', data: data.currentRoundScores });
                promises.push(kvPut('mahjongCurrentRoundScores', data.currentRoundScores));
            }
            if (data.history) {
                console.log('saveToKV: Preparing to save mahjongHistory:', { recordCount: data.history.length });
                operations.push({ key: 'mahjongHistory', data: data.history });
                promises.push(kvPut('mahjongHistory', data.history));
            }
            if (data.banker) {
                console.log('saveToKV: Preparing to save mahjongCurrentBanker:', data.banker);
                operations.push({ key: 'mahjongCurrentBanker', data: data.banker });
                promises.push(kvPut('mahjongCurrentBanker', data.banker));
            }
            if (data.multiplier) {
                console.log('saveToKV: Preparing to save mahjongMultiplier:', data.multiplier);
                operations.push({ key: 'mahjongMultiplier', data: data.multiplier });
                promises.push(kvPut('mahjongMultiplier', data.multiplier));
            }
            
            if (promises.length === 0) {
                console.log('saveToKV: No data to save');
                return false;
            }
            
            console.log('saveToKV: Starting', promises.length, 'operations:', operations.map(op => op.key));
            const results = await Promise.all(promises);
            
            // è¯¦ç»†è®°å½•æ¯ä¸ªæ“ä½œçš„ç»“æœ
            const operationResults = operations.map((op, index) => {
                const success = results[index];
                return { key: op.key, success };
            });
            
            console.log('saveToKV results:', operationResults);
            
            // ç»Ÿè®¡æˆåŠŸå’Œå¤±è´¥çš„æ“ä½œæ•°
            const successCount = operationResults.filter(op => op.success).length;
            const failureCount = operationResults.filter(op => !op.success).length;
            
            console.log('saveToKV operation summary:', { 
                total: operationResults.length, 
                success: successCount, 
                failure: failureCount 
            });
            
            return operationResults;
        }

        // åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®
        function loadFromLocalStorage() {
            // åŠ è½½æ˜µç§°
            const savedNicknames = localStorage.getItem('mahjongNicknames');
            if (savedNicknames) {
                playerNicknames = JSON.parse(savedNicknames);
                updateAllPlayerNames();
            }
            
            // åŠ è½½æ€»åˆ†
            const savedTotals = localStorage.getItem('mahjongTotalScores');
            if (savedTotals) {
                playerTotalScores = JSON.parse(savedTotals);
                updateTotalScoresDisplay();
            }
            
            // åŠ è½½æœ¬å±€åˆ†æ•°
            const savedCurrentRoundScores = localStorage.getItem('mahjongCurrentRoundScores');
            if (savedCurrentRoundScores) {
                currentRoundScores = JSON.parse(savedCurrentRoundScores);
                // æ›´æ–°æœ¬å±€åˆ†æ•°æ˜¾ç¤º
                Object.keys(currentRoundScores).forEach(player => {
                    if (playerScores[player]) {
                        playerScores[player].textContent = currentRoundScores[player];
                        playerScores[player].classList.remove('score-positive', 'score-negative', 'score-zero');
                        if (currentRoundScores[player] > 0) {
                            playerScores[player].classList.add('score-positive');
                        } else if (currentRoundScores[player] < 0) {
                            playerScores[player].classList.add('score-negative');
                        } else {
                            playerScores[player].classList.add('score-zero');
                        }
                    }
                });
            }
            
            // åŠ è½½å†å²è®°å½•
            const savedHistory = localStorage.getItem('mahjongHistory');
            if (savedHistory) {
                historyRecords = JSON.parse(savedHistory);
                currentRoundNumber = historyRecords.length;
                updateHistoryList();
            }
            
            // åŠ è½½åº„å®¶çŠ¶æ€
            const savedBanker = localStorage.getItem('mahjongCurrentBanker');
            if (savedBanker) {
                currentBanker = savedBanker;
                updatePlayerCardState();
            }
            
            // åŠ è½½å€ç‡çŠ¶æ€
            const savedMultiplier = localStorage.getItem('mahjongMultiplier');
            if (savedMultiplier) {
                selectedMultiplier = parseInt(savedMultiplier);
                multiplierSelect.value = selectedMultiplier;
                selectedMultiplierInput.value = selectedMultiplier;
            }
            
            // åˆå§‹åŒ–åŸºç¡€åˆ†è¾“å…¥æ¡†
            setBaseScore(parseInt(baseScoreInput.value) || 1);
        }
        
        // ä¿å­˜åº„å®¶çŠ¶æ€
        function saveBankerToLocalStorage() {
            localStorage.setItem('mahjongCurrentBanker', currentBanker);
            // å¼‚æ­¥ä¿å­˜åˆ° KV
            (async () => {
                await saveToKV({ banker: currentBanker });
            })();
        }
        
        // ä¿å­˜å€ç‡çŠ¶æ€
        function saveMultiplierToLocalStorage() {
            localStorage.setItem('mahjongMultiplier', selectedMultiplier);
            // å¼‚æ­¥ä¿å­˜åˆ° KV
            (async () => {
                await saveToKV({ multiplier: selectedMultiplier });
            })();
        }
        
        // ä¿å­˜æ€»åˆ†åˆ°æœ¬åœ°å­˜å‚¨
        function saveTotalScoresToLocalStorage() {
            // æ·»åŠ æ—¶é—´æˆ³
            const totalScoresWithTimestamp = addTimestamp(playerTotalScores);
            const currentRoundScoresWithTimestamp = addTimestamp(currentRoundScores);
            
            localStorage.setItem('mahjongTotalScores', JSON.stringify(totalScoresWithTimestamp));
            localStorage.setItem('mahjongCurrentRoundScores', JSON.stringify(currentRoundScoresWithTimestamp));
            
            // å¼‚æ­¥ä¿å­˜åˆ° KV
            (async () => {
                await saveToKV({
                    totalScores: totalScoresWithTimestamp,
                    currentRoundScores: currentRoundScoresWithTimestamp
                });
            })();
        }
        
        // æ›´æ–°æ€»åˆ†æ˜¾ç¤º
        function updateTotalScoresDisplay() {
            Object.keys(playerTotals).forEach(player => {
                const total = playerTotalScores[player];
                playerTotals[player].textContent = total;
                playerTotals[player].classList.remove('text-green-600', 'text-red-600', 'text-mahjong-neonGreen');
                if (total > 0) {
                    playerTotals[player].classList.add('text-green-600', 'text-mahjong-neonGreen');
                } else if (total < 0) {
                    playerTotals[player].classList.add('text-red-600');
                } else {
                    playerTotals[player].classList.add('text-mahjong-neonGreen');
                }
            });
        }
        
        // é‡ç½®æ€»åˆ†
        function resetTotalScores() {
            // è®°å½•é‡ç½®æ“ä½œåˆ°å†å²
            const resetRecord = {
                type: 'reset',
                round: currentRoundNumber + 1,
                scores: {
                    player1: -playerTotalScores.player1,
                    player2: -playerTotalScores.player2,
                    player3: -playerTotalScores.player3,
                    player4: -playerTotalScores.player4
                },
                timestamp: new Date().toLocaleString()
            };
            historyRecords.push(resetRecord);
            currentRoundNumber++;
            
            // é‡ç½®æ€»åˆ†
            playerTotalScores = {
                player1: 0,
                player2: 0,
                player3: 0,
                player4: 0
            };
            updateTotalScoresDisplay();
            
            // é‡ç½®æœ¬å±€åˆ†æ•°
            currentRoundScores = {
                player1: 0,
                player2: 0,
                player3: 0,
                player4: 0
            };
            Object.keys(playerScores).forEach(player => {
                if (playerScores[player]) {
                    playerScores[player].textContent = '0';
                    playerScores[player].classList.remove('score-positive', 'score-negative', 'score-zero');
                    playerScores[player].classList.add('score-zero');
                }
            });
            
            // ä¿å­˜æ•°æ®
            saveTotalScoresToLocalStorage();
            localStorage.setItem('mahjongHistory', JSON.stringify(historyRecords));
            updateHistoryList();
            
            // å¼‚æ­¥ä¿å­˜åˆ° KV
            (async () => {
                await saveToKV({ history: historyRecords });
            })();
            
            // éšè—æ“ä½œæŒ‰é’®
            hideAllActionButtons();
            

            
            showToast('æ‰€æœ‰ç©å®¶æ€»åˆ†å·²é‡ç½®ä¸º0');
        }
        
        // é‡ç½®åº„å®¶
        function resetBanker() {
            currentBanker = '';
            selectedWinner = null;
            updatePlayerCardState();
            saveBankerToLocalStorage();
            
            // éšè—æ“ä½œæŒ‰é’®
            hideAllActionButtons();
            

            
            showToast('åº„å®¶å·²é‡ç½®ï¼Œè¯·é‡æ–°é€‰æ‹©');
        }
        
        // äº‹ä»¶ç›‘å¬å™¨ - åŸºç¡€åˆ†å¢å‡
        baseScoreDecrease.addEventListener('click', () => {
            const currentValue = parseInt(baseScoreInput.value) || 1;
            const currentIndex = powerOfTwoValues.indexOf(currentValue);
            if (currentIndex > 0) {
                baseScoreInput.value = powerOfTwoValues[currentIndex - 1];
            }
        });
        
        baseScoreIncrease.addEventListener('click', () => {
            const currentValue = parseInt(baseScoreInput.value) || 1;
            const currentIndex = powerOfTwoValues.indexOf(currentValue);
            if (currentIndex < powerOfTwoValues.length - 1) {
                baseScoreInput.value = powerOfTwoValues[currentIndex + 1];
            } else {
                const nextValue = powerOfTwoValues[currentIndex] * 2;
                powerOfTwoValues.push(nextValue);
                baseScoreInput.value = nextValue;
            }
        });
        
        baseScoreInput.addEventListener('change', () => {
            setBaseScore(parseInt(baseScoreInput.value) || 1);
        });
        
        // äº‹ä»¶ç›‘å¬å™¨ - å€ç‡é€‰æ‹©
        multiplierSelect.addEventListener('change', () => {
            selectedMultiplier = parseInt(multiplierSelect.value);
            selectedMultiplierInput.value = selectedMultiplier;
            saveMultiplierToLocalStorage();
        });
        
        // äº‹ä»¶ç›‘å¬å™¨ - ç©å®¶å¡ç‰‡ç‚¹å‡»
        playerCards.forEach(card => {
            // é¢„å…ˆè·å–å¸¸ç”¨å…ƒç´ ä»¥æé«˜æ€§èƒ½
            const player = card.getAttribute('data-player');
            const actionContainer = card.querySelector('.action-container');
            const bankerBtn = actionContainer?.querySelector('.banker-btn');
            const winnerBtn = actionContainer?.querySelector('.winner-btn');
            
            card.addEventListener('click', (e) => {
                // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°æŒ‰é’®
                if (e.target.closest('.action-btn')) {
                    return;
                }
                
                // é˜»æ­¢æ˜µç§°ç¼–è¾‘åŒºåŸŸçš„ç‚¹å‡»
                if (e.target.classList.contains('player-name') || e.target.closest('.edit-input')) {
                    return;
                }
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯å·²æ¿€æ´»çš„å¡ç‰‡ï¼Œåˆ™éšè—æŒ‰é’®
                if (activePlayerCard === card) {
                    hideAllActionButtons();
                    return;
                }
                
                // éšè—å…¶ä»–å¡ç‰‡çš„æŒ‰é’®
                hideAllActionButtons();
                
                // æ˜¾ç¤ºå½“å‰å¡ç‰‡çš„æŒ‰é’®
                if (actionContainer) {
                    actionContainer.classList.remove('hidden');
                    activePlayerCard = card;
                    
                    // æ ¹æ®æ˜¯å¦æœ‰åº„å®¶æ˜¾ç¤ºä¸åŒçš„æŒ‰é’®
                    if (bankerBtn && winnerBtn) {
                        if (!currentBanker) {
                            // æ²¡æœ‰åº„å®¶æ—¶ï¼Œåªæ˜¾ç¤º"ä¸Šåº„"æŒ‰é’®
                            bankerBtn.classList.remove('hidden');
                            winnerBtn.classList.add('hidden');
                            card.classList.add('banker-candidate');
                        } else {
                            // æœ‰åº„å®¶æ—¶ï¼Œåªæ˜¾ç¤º"èƒ¡"æŒ‰é’®
                            bankerBtn.classList.add('hidden');
                            winnerBtn.classList.remove('hidden');
                            card.classList.add('winner-candidate');
                        }
                    }
                }
            });
        });
        
        // äº‹ä»¶ç›‘å¬å™¨ - ä¸Šåº„æŒ‰é’®ç‚¹å‡»
        document.addEventListener('click', (e) => {
            const bankerBtn = e.target.closest('.banker-btn');
            if (bankerBtn) {
                e.stopPropagation();
                const card = bankerBtn.closest('.score-change');
                const player = card.getAttribute('data-player');
                
                // è®¾ç½®åº„å®¶
                currentBanker = player;
                updatePlayerCardState();
                saveBankerToLocalStorage();
                

                
                // éšè—æ“ä½œæŒ‰é’®
                hideAllActionButtons();
                
                showToast(`${playerNicknames[player]} æˆä¸ºåº„å®¶`);
            }
        });
        
        // äº‹ä»¶ç›‘å¬å™¨ - èƒ¡æŒ‰é’®ç‚¹å‡»
        document.addEventListener('click', (e) => {
            const winnerBtn = e.target.closest('.winner-btn');
            if (winnerBtn) {
                e.stopPropagation();
                const card = winnerBtn.closest('.score-change');
                const player = card.getAttribute('data-player');
                
                // è®¾ç½®èƒ¡ç‰Œè€…
                selectedWinner = player;
                
                // è®¡ç®—å¹¶ä¿å­˜å¾—åˆ†
                if (calculateAndSaveScores()) {
                    // æˆåŠŸè®¡ç®—å¾—åˆ†ï¼ŒæŒ‰é’®å·²éšè—
                } else {
                    // è®¡ç®—å¤±è´¥ï¼Œä¿æŒæŒ‰é’®æ˜¾ç¤º
                    card.classList.add('winner-candidate');
                }
            }
        });
        
        // äº‹ä»¶ç›‘å¬å™¨ - é‡ç½®æ€»åˆ†æŒ‰é’®
        resetTotalBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç©å®¶çš„æ€»åˆ†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                resetTotalScores();
            }
        });
        
        // äº‹ä»¶ç›‘å¬å™¨ - é‡ç½®åº„å®¶æŒ‰é’®
        resetBankerBtn.addEventListener('click', () => {
            resetBanker();
        });
        
        // äº‹ä»¶ç›‘å¬å™¨ - ç¼–è¾‘ç©å®¶æ˜µç§°
        // ä¼˜åŒ–ç©å®¶åç§°ç¼–è¾‘åŠŸèƒ½
        editTriggers.forEach(trigger => {
            trigger.addEventListener('click', (e) => {
                // åªå¤„ç†ç©å®¶åç§°åŒºåŸŸçš„ç‚¹å‡»
                if (trigger.classList.contains('player-name')) {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°å¡ç‰‡
                    
                    if (isEditing) return; // é˜²æ­¢åŒæ—¶ç¼–è¾‘å¤šä¸ªæ˜µç§°
                    isEditing = true;
                    
                    const player = trigger.getAttribute('data-player');
                    const currentName = playerNicknames[player];
                    const playerNumber = player.replace('player', '');
                    
                    // åˆ›å»ºè¾“å…¥æ¡†
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentName;
                    input.className = 'edit-input';
                    input.maxLength = 10; // æœ€å¤§å­—ç¬¦æ•°ï¼Œè€ƒè™‘ä¸­æ–‡è¾“å…¥
                    input.setAttribute('data-player', player);
                    
                    // æ›¿æ¢æ˜¾ç¤ºå…ƒç´ ä¸ºè¾“å…¥æ¡†
                    const parent = trigger.parentNode;
                    parent.insertBefore(input, trigger);
                    parent.removeChild(trigger);
                    
                    // èšç„¦å¹¶é€‰ä¸­è¾“å…¥æ¡†å†…å®¹
                    input.focus();
                    input.select();
                    
                    // å®Œæˆç¼–è¾‘çš„å¤„ç†å‡½æ•°
                    const finishEditing = (save = true) => {
                        // æ£€æŸ¥è¾“å…¥æ¡†æ˜¯å¦ä»ç„¶å­˜åœ¨äºDOMä¸­ï¼Œé˜²æ­¢é‡å¤è°ƒç”¨
                        if (!parent.contains(input)) {
                            return;
                        }
                        
                        // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤è§¦å‘
                        input.removeEventListener('blur', blurHandler);
                        input.removeEventListener('keydown', keydownHandler);
                        
                        let newName = currentName; // é»˜è®¤ä¿æŒåŸåç§°
                        
                        if (save) {
                            // è·å–æ–°åç§°ï¼ˆä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤åç§°ï¼‰
                            let tempName = input.value.trim() || `ç©å®¶${playerNumber}`;
                            
                            // é™åˆ¶ä¸º5ä¸ªæ±‰å­—é•¿åº¦
                            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ä¸­æ–‡
                            const chineseRegex = /[\u4e00-\u9fa5]/g;
                            const chineseMatches = tempName.match(chineseRegex);
                            const chineseCount = chineseMatches ? chineseMatches.length : 0;
                            
                            if (chineseCount > 5) {
                                // å¦‚æœä¸­æ–‡è¶…è¿‡5ä¸ªï¼Œæˆªå–å‰5ä¸ªä¸­æ–‡
                                tempName = tempName.replace(chineseRegex, (match, offset, string) => {
                                    let count = 0;
                                    for (let i = 0; i < offset; i++) {
                                        if (/[\u4e00-\u9fa5]/.test(string[i])) {
                                            count++;
                                        }
                                    }
                                    return count < 5 ? match : '';
                                }).trim();
                            } else if (chineseCount + (tempName.length - chineseCount) > 5) {
                                // å¦‚æœä¸­è‹±æ–‡æ··åˆï¼Œæ€»é•¿åº¦è¶…è¿‡5ä¸ªå­—ç¬¦ï¼Œæˆªå–
                                tempName = tempName.slice(0, 5);
                            }
                            
                            newName = tempName;
                            playerNicknames[player] = newName;
                            
                            // ä¿å­˜æ˜µç§°åˆ°æœ¬åœ°å­˜å‚¨
                            localStorage.setItem('mahjongNicknames', JSON.stringify(playerNicknames));
                            // å¼‚æ­¥ä¿å­˜åˆ° KV
                            (async () => {
                                await saveToKV({ nicknames: playerNicknames });
                            })();
                            

                            
                            // æ˜¾ç¤ºæˆåŠŸæç¤º
                            showToast(`å·²ä¿®æ”¹ä¸ºï¼š${newName}`);
                        }
                        
                        // æ¢å¤æ˜¾ç¤ºå…ƒç´ 
                        trigger.textContent = newName;
                        parent.insertBefore(trigger, input);
                        parent.removeChild(input);
                        
                        // åŒæ­¥æ‰€æœ‰ä½ç½®çš„ç©å®¶åç§°
                        updateAllPlayerNames();
                        
                        // é‡ç½®ç¼–è¾‘çŠ¶æ€
                        isEditing = false;
                    };
                    
                    // å¤±å»ç„¦ç‚¹å®Œæˆç¼–è¾‘
                    const blurHandler = () => finishEditing(true);
                    
                    // é”®ç›˜äº‹ä»¶å¤„ç†
                    const keydownHandler = (e) => {
                        // æŒ‰Enterå®Œæˆç¼–è¾‘
                        if (e.key === 'Enter') {
                            finishEditing(true);
                        }
                        // æŒ‰ESCå–æ¶ˆç¼–è¾‘
                        if (e.key === 'Escape') {
                            finishEditing(false);
                        }
                    };
                    
                    input.addEventListener('blur', blurHandler);
                    input.addEventListener('keydown', keydownHandler);
                }
            });
        });
        
        // äº‹ä»¶ç›‘å¬å™¨ - å†å²è®°å½•æŒ‰é’®
        historyBtn.addEventListener('click', () => {
            historyModal.classList.remove('hidden');
        });
        
        // äº‹ä»¶ç›‘å¬å™¨ - å…³é—­å†å²è®°å½•æ¨¡æ€æ¡†
        closeModal.addEventListener('click', () => {
            historyModal.classList.add('hidden');
        });
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        historyModal.addEventListener('click', (e) => {
            if (e.target === historyModal) {
                historyModal.classList.add('hidden');
            }
        });
        
        // æ¸…ç©ºå†å²è®°å½•å¹¶é‡ç½®æ€»åˆ†å’Œåº„å®¶
        clearHistoryBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å¹¶é‡ç½®æ€»åˆ†å’Œåº„å®¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                // é‡ç½®æ€»åˆ†
                playerTotalScores = {
                    player1: 0,
                    player2: 0,
                    player3: 0,
                    player4: 0
                };
                updateTotalScoresDisplay();
                
                // é‡ç½®åº„å®¶
                currentBanker = '';
                selectedWinner = null;
                updatePlayerCardState();
                
                // æ¸…ç©ºå†å²è®°å½•
                historyRecords = [];
                currentRoundNumber = 0;
                
                // é‡ç½®æœ¬å±€åˆ†æ•°
                currentRoundScores = {
                    player1: 0,
                    player2: 0,
                    player3: 0,
                    player4: 0
                };
                Object.keys(playerScores).forEach(player => {
                    if (playerScores[player]) {
                        playerScores[player].textContent = '0';
                        playerScores[player].classList.remove('score-positive', 'score-negative', 'score-zero');
                        playerScores[player].classList.add('score-zero');
                    }
                });
                
                // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
                saveTotalScoresToLocalStorage();
                saveBankerToLocalStorage();
                localStorage.setItem('mahjongHistory', JSON.stringify(historyRecords));
                
                // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
                updateHistoryList();
                
                // éšè—æ“ä½œæŒ‰é’®
                hideAllActionButtons();
                

                
                showToast('å†å²è®°å½•å·²æ¸…ç©ºï¼Œæ€»åˆ†å’Œåº„å®¶å·²é‡ç½®');
            }
        });
        
        // æ›´æ–°å†å²è®°å½•åˆ—è¡¨ï¼ˆçŸ©é˜µå¼ï¼‰
        function updateHistoryList() {
            if (historyRecords.length === 0) {
                historyRecordsContainer.innerHTML = '<p class="text-gray-500 text-center italic py-8">æš‚æ— è®°å½•</p>';
                return;
            }
            
            // åˆ›å»ºè¡¨æ ¼
            let tableHtml = `
                <table class="matrix-scoreboard">
                    <thead>
                        <tr>
                            <th class="round-col">å±€æ•°/ç©å®¶</th>
            `;
            
            // æ·»åŠ ç©å®¶è¡¨å¤´ - å›ºå®šé¡ºåº
            const playerOrder = ['player1', 'player2', 'player3', 'player4'];
            playerOrder.forEach(player => {
                tableHtml += `<th>${playerNicknames[player]}</th>`;
            });
            
            tableHtml += `
                            <th class="note-col">å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // æ·»åŠ æ€»åˆ†è¡Œï¼ˆç½®é¡¶ï¼‰
            tableHtml += `<tr class="total-row">`;
            tableHtml += `<td class="round-col">æ€»åˆ†</td>`;
            
            playerOrder.forEach(player => {
                const total = playerTotalScores[player] || 0;
                let totalClass = 'score-zero';
                
                if (total > 0) {
                    totalClass = 'score-positive';
                } else if (total < 0) {
                    totalClass = 'score-negative';
                }
                
                tableHtml += `<td><span class="${totalClass}">${total}</span></td>`;
            });
            
            tableHtml += `<td class="note-col"></td>`;
            tableHtml += `</tr>`;
            
            // é€†åºæ·»åŠ å†å²è®°å½•ï¼ˆæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
            const reversedRecords = [...historyRecords].reverse();
            reversedRecords.forEach(record => {
                let note = '';
                let rowClass = '';
                
                if (record.type === 'round') {
                    note = `èƒ¡: ${playerNicknames[record.winner]}`;
                    if (record.banker === record.winner) {
                        note += '<br>ï¼ˆåº„èƒ¡ï¼‰';
                    } else {
                        note += `<br>åº„: ${playerNicknames[record.banker]}`;
                    }
                    note += `<br>å€ç‡: ${record.baseScore}`;
                } else if (record.type === 'adjustment') {
                    rowClass = 'init-adjust-row';
                    if (record.adjustment.target === 'all') {
                        note = `å…¨ä½“${record.adjustment.value > 0 ? 'åŠ ' : 'å‡'}${Math.abs(record.adjustment.value)}åˆ†`;
                    } else {
                        note = `${playerNicknames[record.adjustment.target]}<br>${record.adjustment.value > 0 ? 'åŠ ' : 'å‡'}${Math.abs(record.adjustment.value)}åˆ†`;
                    }
                } else if (record.type === 'reset') {
                    note = 'é‡ç½®æ‰€æœ‰ç©å®¶<br>æ€»åˆ†';
                }
                
                tableHtml += `<tr class="${rowClass}">`;
                tableHtml += `<td class="round-col">${record.round}</td>`;
                
                // æ·»åŠ æ¯ä¸ªç©å®¶çš„åˆ†æ•°
                playerOrder.forEach(player => {
                    const score = record.scores[player] || 0;
                    let scoreClass = 'score-zero';
                    let cellClass = rowClass ? 'init-adjust-cell' : '';
                    
                    if (score > 0) {
                        scoreClass = 'score-positive';
                    } else if (score < 0) {
                        scoreClass = 'score-negative';
                    }
                    
                    tableHtml += `<td class="${cellClass}"><span class="${scoreClass}">${score !== 0 ? score : '-'}</span></td>`;
                });
                
                tableHtml += `<td class="note-col"><span class="note-text">${note}</span></td>`;
                tableHtml += `</tr>`;
            });
            
            tableHtml += `
                    </tbody>
                </table>
            `;
            
            historyRecordsContainer.innerHTML = tableHtml;
        }
        
        // åˆ†æ•°è°ƒæ•´æŒ‰é’®äº‹ä»¶
        applyAdjustBtn.addEventListener('click', applyScoreAdjustment);
        
        // æŒ‰å›è½¦åº”ç”¨åˆ†æ•°è°ƒæ•´
        scoreAdjustValue.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                applyScoreAdjustment();
            }
        });
        
        // åˆå§‹åŒ–åº”ç”¨æ•°æ®
        async function initializeApp() {
            console.log('initializeApp started');
            
            // ä»æœ¬åœ°å­˜å‚¨é¢„åŠ è½½æ•°æ®
            const localData = {
                nicknames: localStorage.getItem('mahjongNicknames') ? JSON.parse(localStorage.getItem('mahjongNicknames')) : null,
                totalScores: localStorage.getItem('mahjongTotalScores') ? JSON.parse(localStorage.getItem('mahjongTotalScores')) : null,
                currentRoundScores: localStorage.getItem('mahjongCurrentRoundScores') ? JSON.parse(localStorage.getItem('mahjongCurrentRoundScores')) : null,
                history: localStorage.getItem('mahjongHistory') ? JSON.parse(localStorage.getItem('mahjongHistory')) : null,
                banker: localStorage.getItem('mahjongCurrentBanker'),
                multiplier: localStorage.getItem('mahjongMultiplier')
            };
            
            console.log('Local data:', localData);
            
            // å°è¯•ä» KV åŠ è½½æ•°æ®
            const kvData = await loadFromKV();
            console.log('KV data loaded:', kvData);
            
            let loadedFromKV = false;
            let hasData = false;
            
            if (kvData) {
                // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½• KV æ•°æ®
                hasData = Object.values(kvData).some(value => value !== null);
                console.log('KV has data:', hasData);
                
                // è§£å†³æ•°æ®å†²çªå¹¶åˆå¹¶æ•°æ®
                const resolvedData = {
                    nicknames: resolveDataConflict(localData.nicknames, kvData.nicknames, 'nicknames'),
                    totalScores: resolveDataConflict(localData.totalScores, kvData.totalScores, 'totalScores'),
                    currentRoundScores: resolveDataConflict(localData.currentRoundScores, kvData.currentRoundScores, 'currentRoundScores'),
                    history: resolveDataConflict(localData.history, kvData.history, 'history'), // ä½¿ç”¨resolveDataConflictåˆå¹¶å†å²è®°å½•
                    banker: resolveDataConflict(localData.banker, kvData.banker, 'banker'),
                    multiplier: resolveDataConflict(localData.multiplier, kvData.multiplier, 'multiplier')
                };
                
                console.log('Resolved data after conflict resolution:', resolvedData);
                
                // ä½¿ç”¨è§£å†³åçš„æ•°æ®
                if (resolvedData.nicknames) {
                    console.log('Using resolved nicknames from KV');
                    playerNicknames = resolvedData.nicknames;
                    updateAllPlayerNames();
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('mahjongNicknames', JSON.stringify(playerNicknames));
                    loadedFromKV = true;
                } else {
                    console.log('No resolved nicknames from KV');
                }
                
                if (resolvedData.totalScores) {
                    console.log('Using resolved totalScores from KV');
                    playerTotalScores = resolvedData.totalScores;
                    updateTotalScoresDisplay();
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('mahjongTotalScores', JSON.stringify(playerTotalScores));
                    loadedFromKV = true;
                } else {
                    console.log('No resolved totalScores from KV');
                }
                
                if (resolvedData.currentRoundScores) {
                    console.log('Using resolved currentRoundScores from KV');
                    currentRoundScores = resolvedData.currentRoundScores;
                    // æ›´æ–°æœ¬å±€åˆ†æ•°æ˜¾ç¤º
                    Object.keys(currentRoundScores).forEach(player => {
                        if (playerScores[player]) {
                            playerScores[player].textContent = currentRoundScores[player];
                            playerScores[player].classList.remove('score-positive', 'score-negative', 'score-zero');
                            if (currentRoundScores[player] > 0) {
                                playerScores[player].classList.add('score-positive');
                            } else if (currentRoundScores[player] < 0) {
                                playerScores[player].classList.add('score-negative');
                            } else {
                                playerScores[player].classList.add('score-zero');
                            }
                        }
                    });
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('mahjongCurrentRoundScores', JSON.stringify(currentRoundScores));
                    loadedFromKV = true;
                } else {
                    console.log('No resolved currentRoundScores from KV');
                }
                
                if (resolvedData.history) {
                    console.log('Using resolved history from KV');
                    historyRecords = resolvedData.history;
                    currentRoundNumber = historyRecords.length;
                    updateHistoryList();
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('mahjongHistory', JSON.stringify(historyRecords));
                    loadedFromKV = true;
                } else {
                    console.log('No resolved history from KV');
                }
                
                if (resolvedData.banker) {
                    console.log('Using resolved banker from KV');
                    currentBanker = resolvedData.banker;
                    updatePlayerCardState();
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('mahjongCurrentBanker', currentBanker);
                    loadedFromKV = true;
                } else {
                    console.log('No resolved banker from KV');
                }
                
                if (resolvedData.multiplier) {
                    console.log('Using resolved multiplier from KV');
                    selectedMultiplier = parseInt(resolvedData.multiplier);
                    multiplierSelect.value = selectedMultiplier;
                    selectedMultiplierInput.value = selectedMultiplier;
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('mahjongMultiplier', selectedMultiplier);
                    loadedFromKV = true;
                } else {
                    console.log('No resolved multiplier from KV');
                }
                
                if (loadedFromKV) {
                    console.log('Data successfully loaded from KV');
                    showToast('æ•°æ®å·²ä»äº‘ç«¯åŒæ­¥');
                } else {
                    console.log('No data loaded from KV');
                }
            }
            
            // å¦‚æœæ²¡æœ‰ä» KV åŠ è½½åˆ°æ•°æ®ï¼Œå°è¯•ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ•°æ®
            console.log('Checking data availability:', { hasData, hasLocalData: Object.values(localData).some(value => value !== null) });
            
            if (!hasData) {
                console.log('No data from KV, checking local storage');
                // æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°å­˜å‚¨æ•°æ®
                const hasLocalData = Object.values(localData).some(value => value !== null);
                console.log('Local data availability:', { hasLocalData });
                
                if (hasLocalData) {
                    console.log('Loading data from localStorage');
                    loadFromLocalStorage();
                    
                    // å°†æœ¬åœ°æ•°æ®åŒæ­¥åˆ° KV
                    console.log('Syncing local data to KV');
                    (async () => {
                        const syncResult = await saveToKV({
                            nicknames: playerNicknames,
                            totalScores: addTimestamp(playerTotalScores),
                            currentRoundScores: addTimestamp(currentRoundScores),
                            history: historyRecords,
                            banker: currentBanker,
                            multiplier: selectedMultiplier
                        });
                        console.log('Local data sync to KV result:', syncResult);
                    })();
                } else {
                    // æ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼å¹¶ä¿å­˜åˆ° KV å’Œæœ¬åœ°å­˜å‚¨
                    console.log('No data found in KV or localStorage, initializing default data');
                    
                    // è®°å½•é»˜è®¤æ•°æ®
                    console.log('Default data:', {
                        nicknames: playerNicknames,
                        totalScores: playerTotalScores,
                        currentRoundScores: currentRoundScores,
                        history: historyRecords,
                        banker: currentBanker,
                        multiplier: selectedMultiplier
                    });
                    
                    // æ›´æ–°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('mahjongNicknames', JSON.stringify(playerNicknames));
                    localStorage.setItem('mahjongTotalScores', JSON.stringify(addTimestamp(playerTotalScores)));
                    localStorage.setItem('mahjongCurrentRoundScores', JSON.stringify(addTimestamp(currentRoundScores)));
                    localStorage.setItem('mahjongHistory', JSON.stringify(historyRecords));
                    localStorage.setItem('mahjongCurrentBanker', currentBanker);
                    localStorage.setItem('mahjongMultiplier', selectedMultiplier);
                    
                    console.log('Default data saved to localStorage');
                    
                    // ä¿å­˜åˆ° KV
                    (async () => {
                        console.log('Saving default data to KV');
                        const saveResult = await saveToKV({
                            nicknames: playerNicknames,
                            totalScores: addTimestamp(playerTotalScores),
                            currentRoundScores: addTimestamp(currentRoundScores),
                            history: historyRecords,
                            banker: currentBanker,
                            multiplier: selectedMultiplier
                        });
                        console.log('Default data save to KV result:', saveResult);
                    })();
                    
                    showToast('å·²åˆå§‹åŒ–é»˜è®¤æ•°æ®');
                }
            }
            
            // åˆå§‹åŒ–åŸºç¡€åˆ†è¾“å…¥æ¡†
            setBaseScore(parseInt(baseScoreInput.value) || 1);
            console.log('initializeApp completed');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('=== DOMContentLoaded Event Started ===');
            
            // ç¡®ä¿toaståˆå§‹çŠ¶æ€æ­£ç¡®
            toast.classList.add('hidden');
            console.log('Toast initial state set to hidden');
            
            // æ£€æŸ¥è¾¹ç¼˜ç¯å¢ƒ
            const isEdge = isEdgeEnvironment();
            console.log('Edge environment check result:', isEdge);
            console.log('my_kv variable availability:', typeof my_kv !== 'undefined' ? 'Available' : 'Not available');
            
            // åˆå§‹åŒ–åº”ç”¨æ•°æ®
            console.log('Starting application initialization...');
            await initializeApp();
            console.log('Application initialization completed');
            
            // æ•°æ®æµå‘ç¡®è®¤
            console.log('=== Data Flow Confirmation ===');
            console.log('Final playerTotalScores after initialization:', playerTotalScores);
            console.log('Final currentRoundScores after initialization:', currentRoundScores);
            console.log('Final historyRecords after initialization:', historyRecords);
            console.log('Final currentBanker after initialization:', currentBanker);
            console.log('Final selectedMultiplier after initialization:', selectedMultiplier);
            
            // ç¡®è®¤æœ¬åœ°å­˜å‚¨æ•°æ®
            console.log('=== Local Storage Data ===');
            const localStorageKeys = ['mahjongNicknames', 'mahjongTotalScores', 'mahjongCurrentRoundScores', 'mahjongHistory', 'mahjongCurrentBanker', 'mahjongMultiplier'];
            localStorageKeys.forEach(key => {
                const value = localStorage.getItem(key);
                console.log(`  - ${key}: ${value ? `Exists (${value.length} chars)` : 'Not found'}`);
            });
            
            // æ£€æŸ¥DOMå…ƒç´ çŠ¶æ€
            console.log('=== DOM Elements State ===');
            updateTotalScoresDisplay();
            updatePlayerCardState();
            console.log('Display updated with current scores and player states');
            
            // å®Œæˆåˆå§‹åŒ–
            console.log('=== Application Initialization Complete ===');
        });
    </script>
</body>
</html>